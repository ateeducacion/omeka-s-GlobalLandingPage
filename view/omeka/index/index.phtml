<?php
/**
 * @var Laminas\View\Renderer\PhpRenderer $this
 * @var string|null $headline
 * @var string|null $lead
 * @var string|null $primaryActionLabel
 * @var string|null $primaryActionUrl
 * @var array $recentItems
 */

$headline = $this->headline ?? $this->translate('Servicio Mediateca'); // @translate
$lead = $this->lead ?? $this->translate('Repositorio de medios audiovisuales educativos.'); // @translate
$primaryActionLabel = $this->primaryActionLabel ?? $this->translate('Browse Collections'); // @translate
$primaryActionUrl = $this->primaryActionUrl ?? '#collections';
$heroImage = $this->heroImage ?? null;

$featuredSites = [];
$featuredSiteIds = $this->setting(\GlobalLandingPage\Module::SETTING_FEATURED_SITES, []);
if (is_array($featuredSiteIds)) {
    foreach ($featuredSiteIds as $siteId) {
        $siteId = (int) $siteId;
        if ($siteId <= 0) {
            continue;
        }
        try {
            $featuredSites[] = $this->api()->read('sites', $siteId)->getContent();
        } catch (\Exception $exception) {
            continue;
        }
    }
}

$baseSiteSlug = (string) $this->setting(\GlobalLandingPage\Module::SETTING_BASE_SITE, '');
$navPagesSetting = $this->setting(\GlobalLandingPage\Module::SETTING_NAV_PAGES, []);
if (!is_array($navPagesSetting)) {
    $navPagesSetting = [];
}

$navItems = [
    [
        'label' => $this->translate('Inicio'),
        'url' => $this->url('globallandingpage', [], true),
        'active' => true,
    ],
    [
        'label' => $this->translate('Explorar Canales'),
        'url' => $this->url('globallandingpage-sites', [], true),
        'active' => false,
    ],
];

if ($baseSiteSlug !== '' && $navPagesSetting !== []) {
    foreach ($navPagesSetting as $slug => $title) {
        if (!is_string($slug) || $slug === '') {
            continue;
        }
        if (!is_string($title) || $title === '') {
            $title = $slug;
        }
        $navItems[] = [
            'label' => $title,
            'url' => $this->url(
                'site/page',
                ['site-slug' => $baseSiteSlug, 'page-slug' => $slug],
                ['force_canonical' => true]
            ),
            'active' => false,
        ];
    }
}

$siteLogosSetting = $this->setting(\GlobalLandingPage\Module::SETTING_LOGOS, []);
$siteLogos = [];
if (is_array($siteLogosSetting) && $siteLogosSetting !== []) {
    foreach ($siteLogosSetting as $assetId) {
        $assetId = (int) $assetId;
        if ($assetId <= 0) {
            continue;
        }

        try {
            $asset = $this->api()->read('assets', $assetId)->getContent();
        } catch (\Exception $exception) {
            continue;
        }

        $src = '';
        $alt = '';
        $label = '';
        $serialized = null;

        if (is_object($asset)) {
            if (method_exists($asset, 'assetUrl')) {
                $src = (string) $asset->assetUrl();
            } elseif (method_exists($asset, 'originalUrl')) {
                $src = (string) $asset->originalUrl();
            } elseif (method_exists($asset, 'thumbnailDisplayUrl')) {
                $src = (string) $asset->thumbnailDisplayUrl('large');
            } elseif (method_exists($asset, 'thumbnailUrl')) {
                $src = (string) $asset->thumbnailUrl('large');
            }

            if (method_exists($asset, 'altText')) {
                $alt = (string) $asset->altText();
            }

            if (method_exists($asset, 'displayTitle')) {
                $label = (string) $asset->displayTitle();
            } elseif (method_exists($asset, 'title')) {
                $label = (string) $asset->title();
            }

            if (method_exists($asset, 'jsonSerialize')) {
                $serialized = $asset->jsonSerialize();
            }
        } elseif (is_array($asset)) {
            $serialized = $asset;
        }

        if (is_array($serialized)) {
            if ($src === '' && isset($serialized['o:original_url']) && is_string($serialized['o:original_url'])) {
                $src = (string) $serialized['o:original_url'];
            }
            if (
                $src === ''
                && isset($serialized['o:thumbnail_urls'])
                && is_array($serialized['o:thumbnail_urls'])
            ) {
                foreach (['large', 'medium', 'square', 'original'] as $thumbnailKey) {
                    if (
                        isset($serialized['o:thumbnail_urls'][$thumbnailKey])
                        && is_string($serialized['o:thumbnail_urls'][$thumbnailKey])
                    ) {
                        $src = (string) $serialized['o:thumbnail_urls'][$thumbnailKey];
                        break;
                    }
                }
            }

            if ($alt === '' && isset($serialized['o:alt_text']) && is_string($serialized['o:alt_text'])) {
                $alt = (string) $serialized['o:alt_text'];
            }
            if ($label === '' && isset($serialized['o:name']) && is_string($serialized['o:name'])) {
                $label = (string) $serialized['o:name'];
            }
        }

        if ($src === '') {
            continue;
        }

        $siteLogos[] = [
            'src' => $src,
            'alt' => $alt !== '' ? $alt : ($label !== '' ? $label : $headline),
        ];
    }
}

if ($siteLogos === []) {
    $siteLogos = \GlobalLandingPage\Module::DEFAULT_LOGOS;
}

$layout = $this->layout();
if ($layout) {
    $layout->setVariable('siteTitle', $headline);
    $layout->setVariable('siteSubtitle', $lead);
    $layout->setVariable('sitesLogos', $siteLogos);
    $layout->setVariable('headerNavigation', $navItems);
}

// Load Masonry and imagesLoaded libraries via CDN
$this->headScript()->appendFile('https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js');
$this->headScript()->appendFile('https://unpkg.com/imagesloaded@5/imagesloaded.pkgd.min.js');
// Load custom Masonry initialization script
$this->headScript()->appendFile($this->assetUrl('js/masonry-init.js', 'GlobalLandingPage'));
?>

<!-- Featured Sites Section -->
<section class="container" id="featured-sites" aria-labelledby="featured-sites-heading">
    <h5 class="title" id="featured-sites-heading">
        <?= $this->translate('Canales de &aacute;reas, proyectos y redes'); ?>
    </h5>
    
    <?php if (!empty($featuredSites)): ?>
        <div class="resource-grid" id="featured-sites-grid">
            <?php foreach ($featuredSites as $site): ?>
                <?php
                $siteSlug = method_exists($site, 'slug') ? $site->slug() : null;
                $siteUrl = method_exists($site, 'siteUrl')
                    ? $site->siteUrl()
                    : ($siteSlug ? $this->url('site', ['site-slug' => $siteSlug]) : '#');
                $siteTitle = method_exists($site, 'title') ? $site->title() : '';
                $thumbnailUrl = method_exists($site, 'thumbnailDisplayUrl')
                    ? $site->thumbnailDisplayUrl('medium')
                    : null;
                $summary = method_exists($site, 'summary') ? (string) $site->summary() : '';
                ?>
                <article class="resource">
                    <a href="<?= $this->escapeHtmlAttr($siteUrl); ?>">
                        <?php if ($thumbnailUrl): ?>
                            <div class="resource__thumbnail">
                                <img 
                                    src="<?= $this->escapeHtmlAttr($thumbnailUrl); ?>" 
                                    alt="<?= $this->escapeHtmlAttr($siteTitle); ?>"
                                    loading="lazy"
                                >
                            </div>
                        <?php else: ?>
                            <div class="resource__thumbnail resource__thumbnail--placeholder">
                                <span class="resource__thumbnail-icon">üèõÔ∏è</span>
                            </div>
                        <?php endif; ?>
                        <div class="resource__content">
                            <h3 class="resource__title"><?= $this->escapeHtml($siteTitle); ?></h3>
                            <?php if ($summary !== ''): ?>
                                <div class="resource__meta">
                                    <p><?= $this->escapeHtml(mb_substr($summary, 0, 100)) . (mb_strlen($summary) > 100 ? '...' : ''); ?></p>
                                </div>
                            <?php endif; ?>
                        </div>
                    </a>
                </article>
            <?php endforeach; ?>
        </div>
    <?php else: ?>
        <p><?= $this->translate('No featured sites available yet.'); ?></p>
    <?php endif; ?>
</section>

<!-- Recent Items Section -->
<section class="container" id="recent-items" aria-labelledby="recent-items-heading" style="margin-top: 3rem;">
    <h5 class="title" id="recent-items-heading">
        <?= $this->translate('Entradas recientes'); ?>
    </h5>
    
    <?php if (!empty($recentItems)): ?>
        <div class="resource-grid" id="recent-items-grid">
            <?php foreach ($recentItems as $item): ?>
                <?php
                $itemTitle = $item->displayTitle();
                $thumbnailUrl = null;
                
                // Get primary media thumbnail
                $primaryMedia = $item->primaryMedia();
                if ($primaryMedia) {
                    $thumbnailUrl = $primaryMedia->thumbnailUrl('large');
                }
                
                // Get resource class label
                $resourceClass = $item->resourceClass();
                $resourceClassLabel = $resourceClass ? $resourceClass->label() : null;
                
                // Get item's associated sites and build proper URL
                $itemUrl = '#';
                try {
                    $itemSites = $item->sites();
                    if (!empty($itemSites)) {
                        // Take the first site
                        $firstSite = reset($itemSites);
                        $siteSlug = method_exists($firstSite, 'slug') ? $firstSite->slug() : null;
                        if ($siteSlug) {
                            $itemUrl=$item->siteUrl($siteSlug);
                        }
                    }
                } catch (\Exception $e) {
                    // If unable to get sites, fallback to default item URL
                    $itemUrl = $item->url();
                }
                ?>
                <article class="resource">
                    <a href="<?= $this->escapeHtmlAttr($itemUrl); ?>">
                        <?php if ($thumbnailUrl): ?>
                            <div class="resource__thumbnail">
                                <img 
                                    src="<?= $this->escapeHtmlAttr($thumbnailUrl); ?>" 
                                    alt="<?= $this->escapeHtmlAttr($itemTitle); ?>"
                                    loading="lazy"
                                >
                            </div>
                        <?php else: ?>
                            <div class="resource__thumbnail resource__thumbnail--placeholder">
                                <span class="resource__thumbnail-icon">üìÑ</span>
                            </div>
                        <?php endif; ?>
                        <div class="resource__content">
                            <h3 class="resource__title"><?= $this->escapeHtml($itemTitle); ?></h3>
                            <?php if ($resourceClassLabel): ?>
                                <div class="resource__meta">
                                    <span class="resource__type"><?= $this->escapeHtml($resourceClassLabel); ?></span>
                                </div>
                            <?php endif; ?>
                        </div>
                    </a>
                </article>
            <?php endforeach; ?>
        </div>
    <?php else: ?>
        <p><?= $this->translate('No items available yet.'); ?></p>
    <?php endif; ?>
</section>

