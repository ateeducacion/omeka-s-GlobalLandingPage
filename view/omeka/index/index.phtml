<?php
/**
 * @var Laminas\View\Renderer\PhpRenderer $this
 * @var string|null $headline
 * @var string|null $lead
 * @var string|null $primaryActionLabel
 * @var string|null $primaryActionUrl
 * @var array $recentItems
 */

$landingConfig = $this->landingPageConfig();
$headline = isset($landingConfig['headline']) && is_string($landingConfig['headline'])
    ? $landingConfig['headline']
    : $this->translate('Servicio Mediateca'); // @translate
$lead = isset($landingConfig['lead']) && is_string($landingConfig['lead'])
    ? $landingConfig['lead']
    : $this->translate('Repositorio de medios audiovisuales educativos.'); // @translate
$primaryActionLabel = $this->primaryActionLabel ?? $this->translate('Browse Collections'); // @translate
$primaryActionUrl = $this->primaryActionUrl ?? '#collections';
$heroImage = $this->heroImage ?? null;

$featuredSites = isset($landingConfig['featuredSites']) && is_array($landingConfig['featuredSites'])
    ? $landingConfig['featuredSites']
    : [];

$layout = $this->layout();
if ($layout) {
    $layout->setVariable('activeNav', 'home');
}

// Load Masonry and imagesLoaded libraries via CDN
$this->headScript()->appendFile('https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js');
$this->headScript()->appendFile('https://unpkg.com/imagesloaded@5/imagesloaded.pkgd.min.js');
// Load custom Masonry initialization script
$this->headScript()->appendFile($this->assetUrl('js/masonry-init.js', 'GlobalLandingPage'));
?>

<!-- Featured Sites Section -->
<section class="container" id="featured-sites" aria-labelledby="featured-sites-heading">
    <h5 class="title" id="featured-sites-heading">
        <?= $this->translate('Canales de &aacute;reas, proyectos y redes'); ?>
    </h5>
    
    <?php if (!empty($featuredSites)): ?>
        <div class="resource-grid" id="featured-sites-grid">
            <?php foreach ($featuredSites as $site): ?>
                <?php
                $siteSlug = method_exists($site, 'slug') ? $site->slug() : null;
                $siteUrl = method_exists($site, 'siteUrl')
                    ? $site->siteUrl()
                    : ($siteSlug ? $this->url('site', ['site-slug' => $siteSlug]) : '#');
                $siteTitle = method_exists($site, 'title') ? $site->title() : '';
                $thumbnailUrl = method_exists($site, 'thumbnailDisplayUrl')
                    ? $site->thumbnailDisplayUrl('medium')
                    : null;
                $summary = method_exists($site, 'summary') ? (string) $site->summary() : '';
                ?>
                <article class="resource">
                    <a href="<?= $this->escapeHtmlAttr($siteUrl); ?>">
                        <?php if ($thumbnailUrl): ?>
                            <div class="resource__thumbnail">
                                <img 
                                    src="<?= $this->escapeHtmlAttr($thumbnailUrl); ?>" 
                                    alt="<?= $this->escapeHtmlAttr($siteTitle); ?>"
                                    loading="lazy"
                                >
                            </div>
                        <?php else: ?>
                            <div class="resource__thumbnail resource__thumbnail--placeholder">
                                <span class="resource__thumbnail-icon">üèõÔ∏è</span>
                            </div>
                        <?php endif; ?>
                        <div class="resource__content">
                            <h3 class="resource__title"><?= $this->escapeHtml($siteTitle); ?></h3>
                            <?php if ($summary !== ''): ?>
                                <div class="resource__meta">
                                    <p><?= $this->escapeHtml(mb_substr($summary, 0, 100)) . (mb_strlen($summary) > 100 ? '...' : ''); ?></p>
                                </div>
                            <?php endif; ?>
                        </div>
                    </a>
                </article>
            <?php endforeach; ?>
        </div>
    <?php else: ?>
        <p><?= $this->translate('No featured sites available yet.'); ?></p>
    <?php endif; ?>
</section>

<!-- Recent Items Section -->
<section class="container" id="recent-items" aria-labelledby="recent-items-heading" style="margin-top: 3rem;">
    <h5 class="title" id="recent-items-heading">
        <?= $this->translate('Entradas recientes'); ?>
    </h5>
    
    <?php if (!empty($recentItems)): ?>
        <div class="resource-grid" id="recent-items-grid">
            <?php foreach ($recentItems as $item): ?>
                <?php
                $itemTitle = $item->displayTitle();
                $thumbnailUrl = null;
                
                // Get primary media thumbnail
                $primaryMedia = $item->primaryMedia();
                if ($primaryMedia) {
                    $thumbnailUrl = $primaryMedia->thumbnailUrl('large');
                }
                
                // Get resource class label
                $resourceClass = $item->resourceClass();
                $resourceClassLabel = $resourceClass ? $resourceClass->label() : null;
                
                // Get item's associated sites and build proper URL
                $itemUrl = '#';
                try {
                    $itemSites = $item->sites();
                    if (!empty($itemSites)) {
                        // Take the first site
                        $firstSite = reset($itemSites);
                        $siteSlug = method_exists($firstSite, 'slug') ? $firstSite->slug() : null;
                        if ($siteSlug) {
                            $itemUrl=$item->siteUrl($siteSlug);
                        }
                    }
                } catch (\Exception $e) {
                    // If unable to get sites, fallback to default item URL
                    $itemUrl = $item->url();
                }
                ?>
                <article class="resource">
                    <a href="<?= $this->escapeHtmlAttr($itemUrl); ?>">
                        <?php if ($thumbnailUrl): ?>
                            <div class="resource__thumbnail">
                                <img 
                                    src="<?= $this->escapeHtmlAttr($thumbnailUrl); ?>" 
                                    alt="<?= $this->escapeHtmlAttr($itemTitle); ?>"
                                    loading="lazy"
                                >
                            </div>
                        <?php else: ?>
                            <div class="resource__thumbnail resource__thumbnail--placeholder">
                                <span class="resource__thumbnail-icon">üìÑ</span>
                            </div>
                        <?php endif; ?>
                        <div class="resource__content">
                            <h3 class="resource__title"><?= $this->escapeHtml($itemTitle); ?></h3>
                            <?php if ($resourceClassLabel): ?>
                                <div class="resource__meta">
                                    <span class="resource__type"><?= $this->escapeHtml($resourceClassLabel); ?></span>
                                </div>
                            <?php endif; ?>
                        </div>
                    </a>
                </article>
            <?php endforeach; ?>
        </div>
    <?php else: ?>
        <p><?= $this->translate('No items available yet.'); ?></p>
    <?php endif; ?>
</section>

